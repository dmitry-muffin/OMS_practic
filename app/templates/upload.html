{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Карта с метками по группам</title>
    <meta charset="utf-8"/>
    <script src="https://api-maps.yandex.ru/2.1/?apikey={{ yandex_api_key }}&lang=ru_RU"
            type="text/javascript"></script>
    <script src="{% static 'js/paintOnMap.js' %}" type="text/javascript"></script>
    <script src="{% static 'js/polygon_custom.js' %}" type="text/javascript"></script>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body>
<h2>Загрузка Excel файла</h2>
<form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <input type="file" name="excel_file" accept=".xlsx" required><br><br>
    <button type="submit">Загрузить</button>
</form>
{% if filename %}
    <p>Загружен файл: <strong>{{ filename }}</strong></p>
{% endif %}

{% if messages %}
<div class="messages">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }}">
        {{ message }}
        {% if all_houses_rows and "ВСЕ" in message|stringformat:"s" or empty_field_rows and "пустыми полями" in message|stringformat:"s" or invalid_houses_rows and "некорректные значения" in message|stringformat:"s" %}
            {% if all_houses_rows|length > 0 or empty_field_rows|length > 0 or invalid_houses_rows|length > 0 %}
            <div class="error-details" style="margin-top: 4px;">
                <a href="#" class="toggle-errors">показать все ошибочные строки</a>
                <div class="full-error-list" style="display: none; max-height: 150px; overflow-y: auto;">
                    {% if "ВСЕ" in message|stringformat:"s" %}
                        {{ all_houses_rows|join:", " }}
                    {% elif "пустыми полями" in message|stringformat:"s" %}
                        {{ empty_field_rows|join:", " }}
                    {% else %}
                        {{ invalid_houses_rows|join:", " }}
                    {% endif %}
                </div>
            </div>
            {% else %}
                <div style="margin-top: 4px;">
                    {% if "ВСЕ" in message|stringformat:"s" %}
                        {{ all_houses_rows|join:", " }}
                    {% elif "пустыми полями" in message|stringformat:"s" %}
                        {{ empty_field_rows|join:", " }}
                    {% else %}
                        {{ invalid_houses_rows|join:", " }}
                    {% endif %}
                </div>
            {% endif %}
        {% endif %}
    </div>
    {% endfor %}
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const toggleButtons = document.querySelectorAll('.toggle-errors');
    toggleButtons.forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const errorList = this.nextElementSibling;
            if (errorList.style.display === 'none') {
                errorList.style.display = 'block';
                this.textContent = 'скрыть список';
            } else {
                errorList.style.display = 'none';
                this.textContent = 'показать все ошибочные строки';
            }
        });
    });
});
</script>

<div id="map"></div>

{% if addresses %}
    {{ addresses|json_script:"addr-data" }}
{% endif %}

{% if addresses %}
    <div style="margin: 10px 0 5px 0; text-align: right;">
        <button id="toggle-all">Выделить все</button>
    </div>
    <div id="checkboxes" style="margin: 10;">
        <h3 style="margin: 5px 0;">Участки:</h3>
    </div>
{% endif %}

<script>
    ymaps.ready(function () {
        const interval = setInterval(() => {
            if (window.map) {
                clearInterval(interval);

                {% if addresses %}
                const addressData = JSON.parse(document.getElementById('addr-data').textContent);

                const FOREST_TOWN_COORDS = [55.711, 49.184];

                const groupColorsList = [
                    '#fb2e02', '#62eaf4', '#f7f30b', '#f99cb0', '#fb9f02',
                    '#a2c91c', '#057ce1', '#a45a3f', '#a402fb', '#05e9c0',
                    '#8c91ee', '#6602fb', '#aaf45a', '#023ffb', '#fe43cd',
                    '#423b43', '#fb6202', '#0cd289', '#d775ff', '#8e8e8d',
                    '#fb026b', '#02b5fb', '#5f7aa1', '#fb9f02', '#2e02fb'
                ];

                const groupColors = {};
                const groupPlacemarks = {};
                const notFoundAddresses = [];

                addressData.forEach(item => {
                    const group = item.group;

                    if (!groupColors[group]) {
                        const color = groupColorsList[(group - 1) % groupColorsList.length];
                        groupColors[group] = color;
                        groupPlacemarks[group] = [];

                        const checkbox = document.createElement("input");
                        checkbox.type = "checkbox";
                        checkbox.id = `group-${group}`;
                        checkbox.checked = true;
                        checkbox.dataset.group = group;

                        const label = document.createElement("label");
                        label.htmlFor = checkbox.id;
                        label.style.display = "inline-block";
                        label.style.marginRight = "20px";
                        label.style.marginBottom = "10px";

                        label.innerHTML = `<span style="
                            display:inline-block;
                            width:12px;
                            height:12px;
                            background-color: ${color};
                            margin-right:5px;
                            border:1px solid #333;
                        "></span> №${group}`;

                        checkbox.addEventListener("change", function () {
                            const checked = this.checked;
                            groupPlacemarks[group].forEach(pm => {
                                if (checked) {
                                    map.geoObjects.add(pm);
                                } else {
                                    map.geoObjects.remove(pm);
                                }
                            });
                        });

                        document.getElementById("checkboxes").appendChild(checkbox);
                        document.getElementById("checkboxes").appendChild(label);
                    }

                    if (item.is_forest_town) {
                        const placemark = new ymaps.Placemark(FOREST_TOWN_COORDS, {
                            hintContent: "ЖК Лесной городок",
                            balloonContent: `№ ${item.group}: ЖК Лесной городок, ${item.street}`
                        }, {
                            preset: 'islands#icon',
                            iconColor: groupColors[item.group],
                            iconCaption: "Лесной городок"
                        });
                        groupPlacemarks[group].push(placemark);
                        map.geoObjects.add(placemark);
                    } else {
                        const address = item.house
                            ? `${item.street}, ${item.house}`
                            : "Казань, " + item.street;

                        ymaps.geocode(address, {results: 1}).then(res => {
                            const geoObject = res.geoObjects.get(0);
                            if (geoObject) {
                                const coords = geoObject.geometry.getCoordinates();
                                const placemark = new ymaps.Placemark(coords, {
                                    hintContent: address,
                                    balloonContent: `№ ${item.group}: ${address}`
                                }, {
                                    preset: 'islands#icon',
                                    iconColor: groupColors[item.group]
                                });
                                groupPlacemarks[group].push(placemark);
                                map.geoObjects.add(placemark);
                            } else {
                                notFoundAddresses.push({
                                    group: item.group,
                                    address: address
                                });
                            }
                        });
                    }
                });

                setTimeout(() => {
                    if (notFoundAddresses.length > 0) {
                        const container = document.createElement('div');
                        container.classList.add('alert', 'alert-warning');
                        container.style.marginTop = '20px';

                        let html = "<strong>Не найдены координаты для адресов:</strong><ul>";
                        notFoundAddresses.forEach(item => {
                            html += `<li>Участок №${item.group}: ${item.address}</li>`;
                        });
                        html += "</ul>";

                        container.innerHTML = html;
                        document.body.appendChild(container);
                    }
                }, 2000);

                document.getElementById("toggle-all").addEventListener("click", () => {
                    const allCheckboxes = document.querySelectorAll('#checkboxes input[type="checkbox"]');
                    const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);

                    allCheckboxes.forEach(cb => {
                        cb.checked = !allChecked;
                        const group = cb.dataset.group;
                        groupPlacemarks[group].forEach(pm => {
                            if (!allChecked) {
                                map.geoObjects.add(pm);
                            } else {
                                map.geoObjects.remove(pm);
                            }
                        });
                    });

                    document.getElementById("toggle-all").innerText = allChecked ? "Выделить все" : "Снять все";
                });
                {% endif %}
            }
        }, 100);
    });
</script>

</body>
</html>